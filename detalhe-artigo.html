<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Geekp√©dia - Detalhe do Artigo</title>

    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=JetBrains+Mono&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      #particles-js {
        position: fixed;
        width: 100%;
        height: 100%;
        background: #0d0d0d;
        top: 0;
        left: 0;
        z-index: -1;
      }
      body {
        font-family: "JetBrains Mono", monospace;
        color: #00fff2;
        background: transparent;
        padding: 20px;
        max-width: 800px;
        margin: auto;
      }
      header {
        margin-bottom: 20px;
      }
      h1 {
        font-family: "Orbitron", sans-serif;
        font-size: 2.2rem;
        color: #00fff2;
        margin-bottom: 0.5rem;
      }
      a.back-link {
        color: #4ddede;
        text-decoration: none;
        font-size: 1rem;
        display: inline-block;
        margin-bottom: 20px;
        cursor: pointer;
      }
      a.back-link:hover {
        text-decoration: underline;
      }
      .article-meta {
        font-size: 0.9rem;
        color: #4ddede;
        margin-bottom: 1rem;
        font-style: italic;
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .article-content {
        background-color: rgba(0, 255, 242, 0.1);
        padding: 15px;
        border-radius: 8px;
        line-height: 1.6;
        font-size: 1rem;
        white-space: pre-wrap;
        flex: 1 1 400px;
        min-width: 300px;
      }
      .btn-excluir {
        margin-top: 20px;
        padding: 10px 15px;
        background-color: #ff4d4d;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s ease;
      }
      .btn-excluir:hover {
        background-color: #cc0000;
      }
      footer {
        margin-top: 40px;
        text-align: center;
        color: #888;
      }

      /* Estilos do popup modal */
      #popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.75);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        font-family: "JetBrains Mono", monospace;
      }
      #popup .popup-content {
        background-color: #111;
        border: 2px solid #00fff2;
        padding: 25px 30px;
        border-radius: 10px;
        max-width: 400px;
        text-align: center;
        color: #00fff2;
        box-shadow: 0 0 10px #00fff2;
      }
      #popup p {
        font-size: 1.1rem;
        margin-bottom: 20px;
      }
      #popup button {
        cursor: pointer;
        font-weight: bold;
        font-family: "JetBrains Mono", monospace;
        padding: 10px 20px;
        margin: 0 8px;
        border-radius: 5px;
        border: none;
        transition: background-color 0.3s ease;
      }
      #btnConfirmarPopup {
        background-color: #ff4d4d;
        color: white;
      }
      #btnConfirmarPopup:hover {
        background-color: #cc0000;
      }
      #btnCancelarPopup {
        background-color: gray;
        color: white;
      }
      #btnCancelarPopup:hover {
        background-color: #555;
      }

      /* Coment√°rios */
      #comentarios-section {
        margin-top: 40px;
        border-top: 1px solid #00fff2;
        padding-top: 20px;
      }
      #listaComentarios > div {
        border-bottom: 1px solid #00fff2;
        padding: 10px 0;
      }
      #listaComentarios strong {
        font-weight: 700;
      }
      #listaComentarios span {
        color: #4ddede;
        font-size: 0.85rem;
      }
      #formComentario label {
        display: block;
        margin-top: 10px;
        margin-bottom: 4px;
      }
      #formComentario textarea {
        background-color: #111;
        border: 1px solid #00fff2;
        color: #00fff2;
        border-radius: 5px;
        padding: 8px;
        font-family: "JetBrains Mono", monospace;
        width: 100%;
        max-width: 500px;
      }
      #formComentario button {
        margin-top: 10px;
        padding: 8px 15px;
        background-color: #00fff2;
        color: #000;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        font-family: "JetBrains Mono", monospace;
      }
      #usuarioLogadoApelido {
        margin-bottom: 10px;
        display: block;
        font-weight: bold;
      }

      /* Container vertical: imagem acima do conte√∫do */
      .flex-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .image-container {
        width: 100%;
        text-align: center;
      }
      #imagem-artigo {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
      }

      /* Responsividade mant√©m o fluxo vertical */
      @media (max-width: 600px) {
        .article-content {
          width: 100% !important;
          flex: none !important;
          min-width: auto !important;
        }
        #imagem-artigo {
          max-width: 100% !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="particles-js"></div>

    <header>
      <a href="#" class="back-link" id="btnVoltar"
        ><i class="fas fa-arrow-left"></i> Voltar</a
      >
      <h1 id="titulo">Carregando...</h1>
      <div class="article-meta" id="meta">
        <span id="dataPub"><i class="fas fa-calendar-alt"></i> --/--/----</span>
        <span id="autor"><i class="fas fa-user"></i> Autor: --</span>
      </div>
    </header>

    <div class="flex-container">
      <div class="image-container">
        <img
          id="imagem-artigo"
          src="URL_DA_IMAGEM_AQUI"
          alt="Imagem do artigo"
        />
        <p id="resolucao-imagem" style="margin-top:8px; color: #ccc; font-size:0.9rem;"></p>
      </div>

      <article id="conteudo" class="article-content">
        <p>Por favor, aguarde enquanto carregamos o artigo.</p>
      </article>
    </div>

    <script>
      function exibirResolucao() {
        const img = document.getElementById("imagem-artigo");
        const info = document.getElementById("resolucao-imagem");
        if (!img || !info) return;
        const largura = img.naturalWidth;
        const altura = img.naturalHeight;
        info.textContent = `Resolu√ß√£o: ${largura} x ${altura}px`;
      }
      // se imagem j√° carregada
      const imgEl = document.getElementById("imagem-artigo");
      imgEl.addEventListener("load", exibirResolucao);
      if (imgEl.complete && imgEl.naturalWidth) {
        exibirResolucao();
      }
    </script>

    <div id="areaExcluir" style="display: none">
      <button class="btn-excluir" id="btnExcluir">üóëÔ∏è Excluir Artigo</button>
    </div>

    <!-- Se√ß√£o Coment√°rios -->
    <section id="comentarios-section">
      <h2>Coment√°rios</h2>

      <div id="listaComentarios">
        <p>Carregando coment√°rios...</p>
      </div>

      <form id="formComentario" style="display: none">
        <span id="usuarioLogadoApelido">Carregando usu√°rio...</span>

        <label for="inputTexto">Coment√°rio:</label>
        <textarea id="inputTexto" name="texto" rows="4" required></textarea>

        <button type="submit">Enviar Coment√°rio</button>
      </form>
    </section>

    <footer>
      <p>üé¨ Geekp√©dia ¬© 2025 - Todos os direitos reservados.</p>
    </footer>

    <!-- Popup Modal -->
    <div id="popup">
      <div class="popup-content">
        <p id="popupMsg">Mensagem do popup</p>
        <button id="btnConfirmarPopup">Confirmar</button>
        <button id="btnCancelarPopup">Cancelar</button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

      const supabaseUrl = "https://odxqvkwxhbfgcmngdhic.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9keHF2a3d4aGJmZ2NtbmdkaGljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNjk1MTMsImV4cCI6MjA2ODg0NTUxM30.U47P-s4GNGgk5f_3cQsBxDVLOqp3-jXsOX14Ok8fZk8";

      const supabase = createClient(supabaseUrl, supabaseKey);

      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      function formatarData(isoDate) {
        if (!isoDate) return "--/--/----";
        const data = new Date(isoDate);
        if (isNaN(data)) return "--/--/----";
        const dia = String(data.getDate()).padStart(2, "0");
        const mes = String(data.getMonth() + 1).padStart(2, "0");
        const ano = data.getFullYear();
        return `${dia}/${mes}/${ano}`;
      }

      // Popup modal
      function abrirPopup(mensagem, aoConfirmar, soMensagem = false) {
        const popup = document.getElementById("popup");
        const msg = document.getElementById("popupMsg");
        const btnConfirmar = document.getElementById("btnConfirmarPopup");
        const btnCancelar = document.getElementById("btnCancelarPopup");

        msg.innerText = mensagem;
        popup.style.display = "flex";

        if (soMensagem) {
          btnConfirmar.style.display = "none";
          btnCancelar.innerText = "Fechar";
        } else {
          btnConfirmar.style.display = "inline-block";
          btnCancelar.innerText = "Cancelar";
        }

        function fechar() {
          popup.style.display = "none";
          btnConfirmar.removeEventListener("click", confirmarHandler);
          btnCancelar.removeEventListener("click", fechar);
        }

        function confirmarHandler() {
          fechar();
          aoConfirmar();
        }

        btnConfirmar.addEventListener("click", confirmarHandler);
        btnCancelar.addEventListener("click", fechar);
      }

      async function carregarComentarios(artigoId) {
        const usuarioLogado = localStorage.getItem("apelido");

        const { data, error } = await supabase
          .from("comentarios")
          .select("id, apelido, texto, criado_em")
          .eq("artigo_id", artigoId)
          .order("criado_em", { ascending: false });

        const listaDiv = document.getElementById("listaComentarios");
        if (error) {
          listaDiv.innerHTML = "<p>Erro ao carregar coment√°rios.</p>";
          return;
        }
        if (!data || data.length === 0) {
          listaDiv.innerHTML = "<p>Seja o primeiro a comentar!</p>";
          return;
        }

        listaDiv.innerHTML = "";

        data.forEach((comentario) => {
          const div = document.createElement("div");

          const apelido = document.createElement("strong");
          apelido.textContent = comentario.apelido + " ";

          const dataFormatada = new Date(comentario.criado_em).toLocaleString(
            "pt-BR",
            {
              dateStyle: "short",
              timeStyle: "short",
            }
          );

          const spanData = document.createElement("span");
          spanData.textContent = ` - ${dataFormatada}`;

          const texto = document.createElement("p");
          texto.textContent = comentario.texto;
          texto.style.margin = "5px 0 0 0";

          div.appendChild(apelido);
          div.appendChild(spanData);
          div.appendChild(texto);

          if (usuarioLogado && usuarioLogado === comentario.apelido) {
            const btnExcluirComentario = document.createElement("button");
            btnExcluirComentario.textContent = "üóëÔ∏è Excluir";
            btnExcluirComentario.className = "btn-excluir";
            btnExcluirComentario.style.marginTop = "8px";
            btnExcluirComentario.style.padding = "5px 10px";
            btnExcluirComentario.style.fontSize = "0.85rem";

            btnExcluirComentario.addEventListener("click", () => {
              abrirPopup("Deseja excluir este coment√°rio?", async () => {
                const { error: erroExcluir } = await supabase
                  .from("comentarios")
                  .delete()
                  .eq("id", comentario.id);

                if (erroExcluir) {
                  abrirPopup("Erro ao excluir coment√°rio.", () => {}, true);
                } else {
                  abrirPopup("Coment√°rio exclu√≠do.", () => {}, true);
                  carregarComentarios(artigoId);
                }
              });
            });

            div.appendChild(btnExcluirComentario);
          }

          listaDiv.appendChild(div);
        });
      }

      async function carregarArtigoDetalhe() {
        const id = getQueryParam("id");

        if (!id) {
          document.getElementById("titulo").innerText = "Artigo n√£o encontrado";
          document.getElementById("conteudo").innerHTML =
            "<p>Par√¢metro inv√°lido ou artigo n√£o especificado.</p>";
          return;
        }

        const { data, error } = await supabase
          .from("artigos")
          .select("titulo, conteudo, criado_em, apelido, url_imagem")
          .eq("id", id)
          .single();

        if (error || !data) {
          document.getElementById("titulo").innerText =
            "Erro ao carregar artigo";
          document.getElementById(
            "conteudo"
          ).innerHTML = `<p>N√£o foi poss√≠vel encontrar o artigo solicitado.</p>`;
          return;
        }
        document.getElementById("titulo").innerText = data.titulo;
        document.getElementById("conteudo").innerHTML =
          data.conteudo || "<p>Conte√∫do n√£o dispon√≠vel.</p>";
        document.getElementById(
          "dataPub"
        ).innerHTML = `<i class="fas fa-calendar-alt"></i> Publicado em: ${formatarData(
          data.criado_em
        )}`;
        document.getElementById(
          "autor"
        ).innerHTML = `<i class="fas fa-user"></i> Autor: ${
          data.apelido || "Desconhecido"
        }`;

        const imgEl = document.getElementById("imagem-artigo");
        if (data.url_imagem) {
          imgEl.src = data.url_imagem;
          imgEl.style.display = "block";
          imgEl.onload = () => {
            exibirResolucao();
          };
        } else {
          imgEl.style.display = "none";
          document.getElementById("resolucao-imagem").textContent = "";
        }

        const usuarioLogado = localStorage.getItem("apelido");
        if (usuarioLogado && usuarioLogado === data.apelido) {
          document.getElementById("areaExcluir").style.display = "block";
        }

        document
          .getElementById("btnExcluir")
          .addEventListener("click", async () => {
            abrirPopup(
              "Tem certeza que deseja excluir este artigo?",
              async () => {
                const { error: deleteError } = await supabase
                  .from("artigos")
                  .delete()
                  .eq("id", id);

                if (deleteError) {
                  abrirPopup("Erro ao excluir artigo.", () => {}, true);
                } else {
                  abrirPopup("Artigo exclu√≠do com sucesso.", () => {}, true);
                  setTimeout(() => {
                    document.getElementById("popup").style.display = "none";
                    window.location.href = "home.html";
                  }, 1000);
                }
              }
            );
          });

        carregarComentarios(id);

        const apelidoUsuarioLogado = localStorage.getItem("apelido");
        const formComentario = document.getElementById("formComentario");
        const usuarioLogadoApelidoSpan = document.getElementById(
          "usuarioLogadoApelido"
        );

        if (!apelidoUsuarioLogado) {
          usuarioLogadoApelidoSpan.innerText =
            "Voc√™ precisa estar logado para comentar.";
          formComentario.style.display = "none";
        } else {
          usuarioLogadoApelidoSpan.innerText = `Comentando como: ${apelidoUsuarioLogado}`;
          formComentario.style.display = "block";
        }
      }

      carregarArtigoDetalhe();

      document
        .getElementById("formComentario")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const apelido = localStorage.getItem("apelido");
          const texto = document.getElementById("inputTexto").value.trim();
          const artigoId = getQueryParam("id");

          if (!apelido) {
            alert("Voc√™ precisa estar logado para comentar.");
            return;
          }
          if (!texto) {
            alert("Por favor, escreva um coment√°rio.");
            return;
          }

          const { error } = await supabase.from("comentarios").insert({
            artigo_id: artigoId,
            apelido,
            texto,
          });

          if (error) {
            alert("Erro ao enviar coment√°rio.");
            return;
          }

          document.getElementById("inputTexto").value = "";
          carregarComentarios(artigoId);
        });

      document
        .getElementById("btnVoltar")
        .addEventListener("click", function (event) {
          event.preventDefault();
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = "index.html";
          }
        });
    </script>

    <script>
      particlesJS("particles-js", {
        particles: {
          number: { value: 90, density: { enable: true, value_area: 800 } },
          color: { value: "#00fff2" },
          shape: { type: "circle" },
          opacity: { value: 0.4 },
          size: { value: 2, random: true },
          line_linked: {
            enable: true,
            distance: 150,
            color: "#00fff2",
            opacity: 0.2,
            width: 1,
          },
          move: { enable: true, speed: 1.5 },
        },
        interactivity: {
          events: {
            onhover: { enable: true, mode: "repulse" },
            onclick: { enable: true, mode: "push" },
          },
        },
        retina_detect: true,
      });
    </script>
  </body>
</html>
